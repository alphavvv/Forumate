name: Build Unsigned IPA

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ "main" ]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build:
    # ä½¿ç”¨æœ€æ–°çš„ macOS runnerï¼Œå·²é¢„è£… Xcode
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¡®ä¿ä½¿ç”¨ç¨³å®šçš„ Xcode ç‰ˆæœ¬
      - name: Select Latest Stable Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      # è°ƒè¯•æ­¥éª¤ï¼šåˆ—å‡ºé¡¹ç›®æ–‡ä»¶å’Œ Schemes
      - name: List project files, targets, å’Œ schemes (debug)
        run: |
          echo "Current directory contents:"
          ls -la
          echo "Xcode Project Schemes and Targets:"
          xcodebuild -list -project Forumate.xcodeproj

      # å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  -scheme å‚æ•°ï¼Œå¹¶å®šä¹‰ Derived Data è·¯å¾„å˜é‡
      - name: Build Unsigned App (.app)
        run: |
          # ğŸš¨ ä¿®æ­£ï¼šä½¿ç”¨ -scheme å‚æ•°æ¥é¿å… xcodebuild æŠ¥é”™ã€‚
          # å‡è®¾ Scheme åç§°ä¸ Target åç§°ç›¸åŒï¼šForumateã€‚
          DERIVED_DATA_PATH="build_output"
         Â 
          mkdir -p $DERIVED_DATA_PATH
         Â 
          xcodebuild build \
            -project Forumate.xcodeproj \
            -scheme Forumate \ # <--- ä¿®æ­£: æ·»åŠ  Scheme
            -target Forumate \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath $DERIVED_DATA_PATH \
            # å…³é—­ç­¾å
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
           Â 
          echo "Build successful. Derived Data Path: $DERIVED_DATA_PATH"
          echo "Listing build products inside Release-iphoneos directory:"
          ls -la $DERIVED_DATA_PATH/Build/Products/Release-iphoneos/

      # å¯¼å‡ºæœªç­¾åçš„ IPA
      - name: Export Unsigned IPA (Manual)
        run: |
          APP_NAME="Forumate.app"
          IPA_NAME="Forumate-unsigned.ipa"
          DERIVED_DATA_PATH="build_output"
         Â 
          # æ ¹æ® xcodebuild çš„è¾“å‡ºç»“æ„ï¼Œç¡®å®š .app æ–‡ä»¶çš„ç²¾ç¡®è·¯å¾„
          # é€šå¸¸æ˜¯ $DERIVED_DATA_PATH/Build/Products/Release-iphoneos/
          APP_PATH="$DERIVED_DATA_PATH/Build/Products/Release-iphoneos/$APP_NAME"
         Â 
          # æ£€æŸ¥ .app æ˜¯å¦å­˜åœ¨
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: .app file not found at expected path: $APP_PATH"
            exit 1
          fi
         Â 
          # 1. åˆ›å»º Payload ç›®å½•
          mkdir -p Payload
         Â 
          # 2. å°† .app å¤åˆ¶åˆ° Payload
          cp -r "$APP_PATH" Payload/
         Â 
          # 3. å‹ç¼© Payload ç›®å½•ç”Ÿæˆ .ipa æ–‡ä»¶
          zip -r "$IPA_NAME" Payload
         Â 
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf $DERIVED_DATA_PATH Payload
         Â 
          echo "IPA exported: $(ls -la *.ipa)"

      - name: Upload Unsigned IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: forumate-unsigned-ipa
          path: Forumate-unsigned.ipa
          retention-days: 7

